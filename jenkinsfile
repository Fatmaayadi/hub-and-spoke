pipeline {
    agent { label 'oci-agent' }

    environment {
        OCI_CONFIG_PATH = ''
        OCI_KEY_PATH = ''
    }

    stages {
        stage('Setup OCI Config') {
            steps {
                withCredentials([
                    file(credentialsId: 'oci-config', variable: 'OCI_CONFIG'),
                    file(credentialsId: 'oci-key', variable: 'OCI_KEY')
                ]) {
                    script {
                        env.OCI_CONFIG_PATH = "${OCI_CONFIG}"
                        env.OCI_KEY_PATH = "${OCI_KEY}"
                    }
                    bat """
                    echo OCI Config temporary path: %OCI_CONFIG_PATH%
                    echo OCI Key temporary path: %OCI_KEY_PATH%
                    """
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('config_test2') {
                    bat """
                    set OCI_CONFIG=%OCI_CONFIG_PATH%
                    set OCI_KEY=%OCI_KEY_PATH%
                    terraform init
                    terraform plan -out=tfplan
                    terraform apply -auto-approve
                    """
                }
            }
        }
    }
}
