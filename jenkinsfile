pipeline {
    agent { label 'oci-agent' }

    stages {
        stage('Setup OCI Config') {
            steps {
                withCredentials([
                    file(credentialsId: 'oci-config', variable: 'OCI_CONFIG'),
                    file(credentialsId: 'oci-key', variable: 'OCI_KEY')
                ]) {
                    sh '''
                        mkdir -p ~/.oci
                        cp $OCI_CONFIG ~/.oci/config
                        cp $OCI_KEY ~/.oci/oci_api_key.pem
                        chmod 600 ~/.oci/oci_api_key.pem
                    '''
                }
            }
        }
        stage('Terraform Apply') {
            steps {
                dir('config_test2') {
                    sh '''
                        terraform init
                        terraform plan -out=tfplan
                        terraform apply -auto-approve
                    '''
                }
            }
        }
    }
}
