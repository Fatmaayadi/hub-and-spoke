pipeline {
    agent { label 'oci-agent' }

    stages {
        stage('Setup OCI Config') {
    steps {
        withCredentials([
            file(credentialsId: 'oci-config', variable: 'OCI_CONFIG'),
            file(credentialsId: 'oci-key', variable: 'OCI_KEY')
        ]) {
            bat """
                REM Create .oci folder in workspace
                if not exist "%WORKSPACE%\\.oci" mkdir "%WORKSPACE%\\.oci"

                REM Copy OCI config and private key into workspace
                copy /Y "%OCI_CONFIG%" "%WORKSPACE%\\.oci\\config"
                copy /Y "%OCI_KEY%" "%WORKSPACE%\\.oci\\oci_api_key.pem"
            """
        }
    }
}



        stage('Terraform Apply') {
            steps {
                dir('config_test2') {
                    bat """
                        REM Read public key from local file
                        set /p PUB_KEY=<"C:\\Users\\DELL\\Downloads\\ayadifatma418@gmail.com-2025-07-10T13_34_58.521Z.pub"

                        terraform init
                        terraform plan -out=tfplan -var "public_ssh_key=%PUB_KEY%"
                        terraform apply -auto-approve -var "public_ssh_key=%PUB_KEY%"
                    """
                }
            }
        }
    }
}
