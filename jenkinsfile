pipeline {
    agent any

    environment {
        OCI_CONFIG = '/home/jenkins/.oci/config'
        OCI_KEY = '/home/jenkins/.oci/oci_api_key.pem'
    }

    stages {
        stage('Prepare Workspace') {
            steps {
                script {
                    echo "Creating workspace .oci folder if not exists"
                    sh '''
                        mkdir -p "$WORKSPACE/.oci"
                    '''
                }
            }
        }

        stage('Copy OCI Config and Key') {
            steps {
                withCredentials([file(credentialsId: 'oci_config', variable: 'OCI_CONFIG_FILE'),
                                 file(credentialsId: 'oci_key', variable: 'OCI_KEY_FILE')]) {
                    sh '''
                        cp "$OCI_CONFIG_FILE" "$WORKSPACE/.oci/config"
                        cp "$OCI_KEY_FILE" "$WORKSPACE/.oci/oci_api_key.pem"
                    '''
                }
            }
        }

        stage('Terraform Init & Apply') {
            steps {
                dir('config_test2') {
                    sh '''
                        terraform init
                        terraform plan  -auto-approve
                        terraform apply -auto-approve
                    '''
                }
            }
        }
    }
}
